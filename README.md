# מערכת דוחות מבוססת תבניות HTML

פרויקט זה מממש מערכת דוחות מתקדמת המבוססת על תבניות HTML, עם יכולת הפקת דוחות בפורמט PDF ו-Excel. המערכת נועדה להחליף את המערכת הקודמת שהייתה מבוססת על טפסי PDF קשיחים.

## יתרונות המערכת

- **גמישות** - שימוש בתבניות HTML נגישות ופשוטות לעריכה
- **תמיכה מיטבית בעברית** - פתרון בעיות כיווניות וטיפוגרפיה בדוחות
- **תחזוקה קלה** - שינוי תבניות ללא תלות במפתחים
- **יכולות מתקדמות** - תמיכה בטבלאות דינמיות, כותרות חוזרות ועוד
- **תאימות אחורה** - תמיכה גם במנגנון הישן לצורך מעבר הדרגתי

## רכיבי המערכת

1. **DLL ראשי**: נקודת כניסה להפקת דוחות שמופעלת מתוך Access
2. **מנהל תבניות HTML**: לטעינה וניהול תבניות HTML
3. **מעבד תבניות**: להחלפת פלייסהולדרים והזרקת נתונים לתבניות
4. **ממיר HTML-to-PDF**: להמרת HTML מעובד לקובץ PDF
5. **יוצר דוחות Excel**: ליצירת קבצי Excel מהנתונים

## מיפוי שמות שדות לעברית

המערכת משתמשת בעיקרון פשוט ואינטואיטיבי למיפוי שמות שדות באנגלית לשמות עבריים. מיפוי זה מתבסס על הפרדה בין שני סוגי שדות:

### 1. שדות מטבלה (עם "_")
- כל שדה שנלקח ישירות מטבלה יוגדר בפורמט `TableName_ColumnName`
- לדוגמה: `ARN_HS`, `CUSTOMERS_NAME`, `HS_ISVKOD`
- המערכת תפצל אוטומטית לפי "_" ותחפש בטבלת המיפויים לפי הטבלה והעמודה

### 2. שדות מחושבים (ללא "_")
- שדות מחושבים או ביטויים יוגדרו ללא "_"
- לדוגמה: `bruto`, `totalAmount`, `activ`
- המערכת תחפש מיפוי לפי שם הפרוצדורה/פונקציה ושם השדה

### דוגמה מעשית

```sql
-- קביעת שמות שדות בשאילתה:
SELECT 
    arn.hs AS ARN_HS,               -- שדה מטבלה
    (arn.paysum - arn.sumhan) AS bruto  -- שדה מחושב
FROM dbo.arn;

-- הגדרת המיפויים לעברית:
INSERT INTO ReportsGeneratorColumns (TableName, ColumnName, HebrewAlias) VALUES
('ARN', 'HS', N'מספר השגחה'),
('GetArnReport', 'bruto', N'סכום ברוטו');
```

## פלייסהולדרים בתבניות

תבניות HTML יכולות להכיל מספר סוגי פלייסהולדרים:

```html
<!-- פלייסהולדרים פשוטים -->
<h1>{{ReportTitle}}</h1>
<p>תאריך: {{CurrentDate}}</p>

<!-- פלייסהולדרים לפרמטרים -->
<p>מתאריך: {{DateFrom}} עד תאריך: {{DateTo}}</p>

<!-- פלייסהולדרים לכותרות עמודות (עם מיפוי אוטומטי לעברית) -->
<th>{{HEADER:ARN_HS}}</th> <!-- יוצג כ"מספר השגחה" -->
<th>{{HEADER:bruto}}</th> <!-- יוצג כ"סכום ברוטו" -->

<!-- טבלאות דינמיות -->
<tr data-table-row="ArnData">
  <td>{{ARN_HS}}</td>
  <td>{{bruto}}</td>
</tr>
```

## הגדרת דוחות

הגדרת דוחות נעשית בטבלאות SQL:

1. **ReportsGenerator**: הגדרות כלליות של הדוחות
2. **ReportsGeneratorColumns**: מיפוי שמות עמודות מאנגלית לעברית

## שימוש

### יצירת דוח חדש

1. הוסף רשומה לטבלת `ReportsGenerator` עם שם הדוח והפרוצדורות הנדרשות
2. הוסף מיפויים לטבלת `ReportsGeneratorColumns` בהתאם לעמודות בדוח
3. צור תבנית HTML עם שם זהה לשם הדוח
4. הוסף פלייסהולדרים לתבנית בהתאם לנתונים הנדרשים

### הפקת דוח מתוך Access

```vb
Dim reportDLL As New ReportGenerator
Dim params As New Dictionary

' הגדרת פרמטרים
params.Add "DateFrom", #1/1/2023#, DbType.Date
params.Add "DateTo", #12/31/2023#, DbType.Date

' הפקת דוח
Dim result = reportDLL.GenerateReport("CustomerReport", OutputFormat.PDF, params)

' שמירת הדוח כקובץ
SaveBytesToFile result, "C:\Reports\CustomerReport.pdf"
```

## דרישות טכניות

- .NET 8.0
- SQL Server 2019 או מעלה
- גישה לתיקיית תבניות ברשת
- ספריות חיצוניות:
  - DinkToPdf (המרת HTML ל-PDF)
  - EPPlus (יצירת קבצי Excel)
  - Dapper (גישה ל-SQL)
  - HtmlAgilityPack (עיבוד HTML)

## התקנה

1. בנה את הפרויקט
2. הרץ את סקריפטי ה-SQL ליצירת הטבלאות
3. הכן את תיקיית התבניות
4. התאם את ההגדרות בקובץ הקונפיגורציה
